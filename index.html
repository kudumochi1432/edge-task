<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edge Task Overlay — Responsive</title>

  <!-- PWA / iOS (optional, keep if you already added in GitHub) -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1020">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1724;
      --accent:#7dd3fc;
      --muted:#9aa4b2;

      --title-size:22px;
      --item-title-size:18px;
      --item-sub-size:14px;
      --meta-size:14px;

      --radius:12px;
      --pad:12px;
      --gap:10px;

      --run-bg: rgba(125, 211, 252, 0.14);
      --run-border: rgba(125, 211, 252, 0.45);
      --sel-border: rgba(255,255,255,0.18);
    }

    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;background:transparent}

    .overlay{
      width:100%; height:100%; min-height:520px;
      padding:var(--pad);
      box-sizing:border-box;
      backdrop-filter:blur(6px);
      background:linear-gradient(180deg, rgba(11,16,32,0.86), rgba(15,23,36,0.82));
      color:#e6eef8;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.06);
      display:flex; flex-direction:column;
      gap:var(--gap);
      overflow:hidden;
    }

    /* Mild compact spacing (auto when embed is small) */
    .overlay.compact{ --pad:10px; --gap:8px; --radius:10px; }

    header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    header h1{font-size:16px;margin:0;white-space:nowrap}
    .clock{font-size:12px;color:var(--muted);white-space:nowrap}

    .now{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);
      padding:10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .nowTitle{
      font-size:var(--title-size);
      font-weight:900;
      line-height:1.12;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .nowMeta{font-size:12px;color:var(--muted);margin-top:6px}

    .muted{color:var(--muted)}

    .listWrap{flex:1;display:flex;flex-direction:column;gap:8px;min-height:0}
    .listTopBar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .filters label{font-size:12px;color:var(--muted);display:inline-flex;gap:6px;align-items:center;user-select:none}
    .filters input{transform:translateY(1px)}

    .list{display:flex;flex-direction:column;gap:8px; overflow:auto; min-height:0; padding-right:2px}

    .list-item{
      display:flex;align-items:flex-start;gap:12px;
      padding:10px;
      border-radius:12px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
    }
    .list-item.selected{border-color:var(--sel-border)}
    .list-item.running{background:var(--run-bg); border-color:var(--run-border)}

    .checkbox{width:30px;height:30px;border-radius:10px;border:2px solid rgba(255,255,255,0.10);display:flex;align-items:center;justify-content:center;font-weight:900;flex:0 0 auto}
    .checkbox.done{background:linear-gradient(90deg,#86efac,#34d399);border:none;color:#05221a}

    .item-body{flex:1;min-width:0}
    .item-title{font-weight:900;font-size:var(--item-title-size);line-height:1.15;word-break:break-word;overflow-wrap:anywhere}
    .list-item.running .item-title{color:var(--accent)}

    .item-sub{font-size:var(--item-sub-size);color:var(--muted);margin-top:4px;word-break:break-word;overflow-wrap:anywhere}

    .item-actions{display:flex;flex-direction:column;gap:8px;flex:0 0 auto;opacity:0.95}

    button{
      background:transparent;
      border:1px solid rgba(255,255,255,0.12);
      padding:10px 12px;
      border-radius:10px;
      color:inherit;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    button:active{transform:translateY(1px)}

    .primary{border-color:rgba(125,211,252,0.45)}
    .danger{border-color:rgba(248,113,113,0.55)}

    .rowActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .bottom{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap}

    .time-input{
      background:transparent;
      border:1px dashed rgba(255,255,255,0.10);
      padding:12px 12px;
      border-radius:10px;
      color:#d7e2ee;
      font-size:var(--meta-size);
      flex:1 1 260px;
      min-width:180px;
      outline:none;
    }
    .time-input::placeholder{color:rgba(154,164,178,0.85)}

    /* Bigger hit area for the slider on mobile */
    .settings{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted);flex-wrap:wrap}
    .settings input[type="range"]{width:min(260px, 70vw); height:28px;}
    input[type="range"]::-webkit-slider-thumb{width:26px;height:26px;border-radius:999px;}
    input[type="range"]::-moz-range-thumb{width:26px;height:26px;border-radius:999px;border:none;}

    .toggle{display:inline-flex;align-items:center;gap:6px;user-select:none}
    .toggle input{transform:translateY(1px)}

    select{background:rgba(255,255,255,0.03);color:#e6eef8;border:1px solid rgba(255,255,255,0.10);border-radius:10px;padding:9px 10px;font-size:12px}

    .chipbar{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:10px 12px;border-radius:999px;font-size:13px}

    footer{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .export{font-size:12px;color:var(--muted)}

    /* Focus mode: show only the running task (or selected) */
    .overlay.focus header,
    .overlay.focus .listWrap,
    .overlay.focus .bottom,
    .overlay.focus footer,
    .overlay.focus #nowBar{display:none;}

    .focusScreen{display:none; flex:1; min-height:0;}
    .overlay.focus .focusScreen{display:flex;}

    .focusCard{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:16px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.08);
      background:linear-gradient(180deg, rgba(125,211,252,0.10), rgba(255,255,255,0.03));
      overflow:hidden;
    }

    .focusTop{display:flex;flex-direction:column;gap:10px;align-items:flex-start}
    .focusTitle{font-size:calc(var(--title-size) + 8px);font-weight:1000;line-height:1.08;word-break:break-word;overflow-wrap:anywhere}
    .focusNote{font-size:15px;color:#d7e2ee;opacity:0.95;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;flex:1;overflow:auto;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:10px;background:rgba(0,0,0,0.12)}
    .focusMeta{font-size:12px;color:var(--muted)}

    .focusActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-start}

    /* Landscape: "文字だけで集中" がしやすい */
    @media (orientation: landscape) and (max-height: 430px){
      .focusCard{padding:14px}
      .focusTitle{font-size:calc(var(--title-size) + 12px)}
      .focusNote{display:none}
      .focusActions button{font-size:14px;padding:10px 14px}
    }

    dialog{border:none;border-radius:14px;padding:0;max-width:min(860px, 96vw);width:min(860px, 96vw);}
    dialog::backdrop{background:rgba(0,0,0,0.55)}
    .modal{background:rgba(15,23,36,0.98);color:#e6eef8;border:1px solid rgba(255,255,255,0.08);border-radius:14px;overflow:hidden}
    .modal header{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.06)}
    .modal .body{padding:12px 14px;display:flex;flex-direction:column;gap:10px}
    .modal textarea{width:100%;min-height:240px;resize:vertical;background:rgba(255,255,255,0.03);color:#e6eef8;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:10px;font-size:13px;line-height:1.4}
    .modal .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .settingsGrid{display:grid;grid-template-columns:1fr;gap:10px}
    .settingsRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .settingsRow input[type="text"]{background:rgba(255,255,255,0.03);color:#e6eef8;border:1px solid rgba(255,255,255,0.10);border-radius:10px;padding:10px 12px;min-width:160px}
    .settingsRow input[type="color"]{width:44px;height:38px;border:none;background:transparent;padding:0}

    @media (max-width:360px){
      header h1{font-size:15px}
      .time-input{flex:1 1 100%; min-width:0}
      button{flex:1 1 auto; justify-content:center}
      .now{padding:10px}
      .focusTitle{font-size:calc(var(--title-size) + 4px)}
    }
  </style>
</head>
<body>
  <div class="overlay" id="app">
    <header>
      <h1>タスクボード</h1>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="clock" id="clock">--:--</div>
        <button id="openSettings" title="設定" aria-label="設定">⚙︎</button>
      </div>
    </header>

    <section class="now" id="nowBar">
      <div style="min-width:0;flex:1;">
        <div class="nowTitle" id="nowTitle">いま: （未選択）</div>
        <div class="nowMeta" id="nowMeta">クリックでタスクを選択。開始すると“いま”に表示されます。</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
        <button id="toggleFocus" class="primary" title="開始中タスクだけ表示">集中</button>
        <button id="openSummary">サマリー</button>
      </div>
    </section>

    <section class="listWrap">
      <div class="listTopBar">
        <div style="font-size:12px;color:var(--muted);">タスク一覧</div>
        <div class="filters">
          <label title="今日作成したタスクだけを表示します"><input id="todayOnly" type="checkbox" /> 今日だけ</label>
          <label title="完了タスクを隠します"><input id="hideDone" type="checkbox" /> 完了を折りたたむ</label>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <section class="bottom">
      <div class="row">
        <input id="quickAdd" class="time-input" placeholder="新しいタスクを入力 → 追加" />
        <div class="rowActions" style="flex:0 0 auto;">
          <button id="addBtn" class="primary">追加</button>
        </div>
      </div>

      <div class="row">
        <input id="timeNote" class="time-input" placeholder="選択中タスクのメモ（例: 13:30-14:10 / 気づき / 次やること）" />
        <div class="rowActions" style="flex:0 0 auto;">
          <button id="appendNow" title="いまの時刻を追記">＋いま</button>
          <button id="saveNote" class="primary" title="選択中タスクにメモを保存">メモ保存</button>
        </div>
      </div>

      <!-- Quick insert buttons for memo (楽に打つ用) -->
      <div class="chipbar">
        <button class="chip" id="chipStart" title="開始時刻を 'HH:MM-' 形式で追記">開始</button>
        <button class="chip" id="chipEnd" title="終了時刻を追記">終了</button>
        <button class="chip" id="chipSlash" title="区切り ' / ' を追加">/</button>
        <button class="chip" id="chipNext" title="次やることのテンプレ">次：</button>
      </div>

      <div class="settings">
        <label>追加順</label>
        <select id="orderSelect" title="新しいタスクの位置">
          <option value="top">新しいタスクが上</option>
          <option value="bottom">新しいタスクが下</option>
        </select>

        <label>文字サイズ</label>
        <input id="fontRange" type="range" min="14" max="64" step="1" />
        <div id="fontValue" style="min-width:44px;text-align:right"></div>

        <span class="muted">（n:追加 / c:開始停止 / d:Done / f:集中 / Esc:戻る）</span>
      </div>
    </section>

    <footer>
      <div class="export"><span id="summaryCount">0</span> 件 — 今日の完了: <span id="doneCount">0</span></div>
      <div class="rowActions">
        <button id="clearBtn" class="danger">全クリア</button>
      </div>
    </footer>

    <!-- Focus screen -->
    <section class="focusScreen" id="focusScreen">
      <div class="focusCard">
        <div class="focusTop">
          <div class="focusMeta" id="focusMeta">集中モード</div>
          <div class="focusTitle" id="focusTitle">（開始中タスクなし）</div>
          <div class="focusActions">
            <button id="focusAppendNow">＋いま</button>
            <button id="focusStop" class="primary">停止</button>
            <button id="focusBack" class="primary">戻る</button>
          </div>
        </div>
        <div class="focusNote" id="focusNote">開始中タスクがないときは、通常表示に戻って開始してください。</div>
      </div>
    </section>
  </div>

  <dialog id="summaryDialog">
    <div class="modal">
      <header>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;">今日のサマリー</div>
          <button id="closeSummary">閉じる</button>
        </div>
      </header>
      <div class="body">
        <div class="muted" id="summaryMeta">--</div>
        <textarea id="summaryText" readonly></textarea>
        <div class="actions">
          <button id="copySummary">コピー</button>
          <button id="downloadSummary">TXT 保存</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="settingsDialog">
    <div class="modal">
      <header>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;">設定</div>
          <button id="closeSettings">閉じる</button>
        </div>
      </header>
      <div class="body">
        <div class="settingsGrid">
          <div class="muted">色（差し色）</div>
          <div class="settingsRow">
            <input id="accentPicker" type="color" />
            <input id="accentHex" type="text" placeholder="#7dd3fc" />
            <button id="applyAccent" class="primary">適用</button>
            <button id="resetAccent">リセット</button>
          </div>
          <div class="muted">ヒント：#RRGGBB で好きな色にできます（例 #7dd3fc）。</div>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    const $ = id => document.getElementById(id);

    // --- Clock ---
    const clock = $('clock');
    function tick(){ clock.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
    setInterval(tick, 1000); tick();

    // --- Helpers ---
    function pad2(n){return String(n).padStart(2,'0');}
    function nowHM(){ const d = new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
    function localYMD(d){ const y=d.getFullYear(); const m=pad2(d.getMonth()+1); const day=pad2(d.getDate()); return `${y}-${m}-${day}`; }
    function isToday(ts){ return localYMD(new Date(ts)) === localYMD(new Date()); }

    // --- Theme (accent) ---
    const DEFAULT_ACCENT = '#7dd3fc';
    function normalizeHex(s){
      if(!s) return null;
      s = String(s).trim();
      if(!s.startsWith('#')) s = '#' + s;
      if(/^#[0-9a-fA-F]{6}$/.test(s)) return s.toLowerCase();
      return null;
    }
    function applyAccent(hex){
      document.documentElement.style.setProperty('--accent', hex);
      // keep derived borders in sync
      document.documentElement.style.setProperty('--run-bg', 'rgba(125, 211, 252, 0.14)');
      localStorage.setItem('edge_accent', hex);
    }
    const savedAccent = normalizeHex(localStorage.getItem('edge_accent')) || DEFAULT_ACCENT;
    applyAccent(savedAccent);

    // Settings dialog
    const settingsDialog = $('settingsDialog');
    $('openSettings').onclick = ()=>{
      const cur = normalizeHex(localStorage.getItem('edge_accent')) || DEFAULT_ACCENT;
      $('accentPicker').value = cur;
      $('accentHex').value = cur;
      settingsDialog.showModal();
    };
    $('closeSettings').onclick = ()=> settingsDialog.close();

    $('applyAccent').onclick = ()=>{
      const hex = normalizeHex($('accentHex').value) || normalizeHex($('accentPicker').value);
      if(!hex) return alert('カラーコードは #RRGGBB の形式で入力してください（例: #7dd3fc）');
      $('accentHex').value = hex;
      $('accentPicker').value = hex;
      applyAccent(hex);
      render();
    };

    $('accentPicker').addEventListener('input', ()=>{ $('accentHex').value = $('accentPicker').value; });
    $('resetAccent').onclick = ()=>{
      localStorage.removeItem('edge_accent');
      $('accentPicker').value = DEFAULT_ACCENT;
      $('accentHex').value = DEFAULT_ACCENT;
      applyAccent(DEFAULT_ACCENT);
      render();
    };

    // --- Settings: font size ---
    const defaultFont = parseInt(localStorage.getItem('edge_font') || '22', 10);
    function applyFontSize(size){
      document.documentElement.style.setProperty('--title-size', size + 'px');
      document.documentElement.style.setProperty('--item-title-size', Math.max(14, size - 4) + 'px');
      document.documentElement.style.setProperty('--item-sub-size', Math.max(12, size - 10) + 'px');
      document.documentElement.style.setProperty('--meta-size', Math.max(12, size - 10) + 'px');
      $('fontValue').textContent = size + 'px';
      localStorage.setItem('edge_font', String(size));
    }
    const fontRange = $('fontRange');
    fontRange.value = defaultFont;
    fontRange.addEventListener('input', () => applyFontSize(parseInt(fontRange.value, 10)));
    applyFontSize(defaultFont);

    // --- Mild compact (auto when embed is small) ---
    const app = $('app');
    function evaluateAutoCompact(){
      const w = app.clientWidth;
      const h = app.clientHeight;
      const shouldCompact = (w <= 380) || (h <= 620);
      app.classList.toggle('compact', shouldCompact);
    }
    if('ResizeObserver' in window){
      const ro = new ResizeObserver(()=> evaluateAutoCompact());
      ro.observe(app);
    } else {
      window.addEventListener('resize', evaluateAutoCompact);
      setInterval(evaluateAutoCompact, 1200);
    }

    // --- Filters (persisted) ---
    const todayOnly = $('todayOnly');
    const hideDone = $('hideDone');
    todayOnly.checked = (localStorage.getItem('edge_today_only') === '1');
    hideDone.checked = (localStorage.getItem('edge_hide_done') !== '0'); // default ON
    todayOnly.addEventListener('change', ()=>{ localStorage.setItem('edge_today_only', todayOnly.checked ? '1':'0'); render(); });
    hideDone.addEventListener('change', ()=>{ localStorage.setItem('edge_hide_done', hideDone.checked ? '1':'0'); render(); });

    // --- Order toggle (persisted) ---
    const orderSelect = $('orderSelect');
    orderSelect.value = (localStorage.getItem('edge_order') || 'top');
    orderSelect.addEventListener('change', ()=>{ localStorage.setItem('edge_order', orderSelect.value); render(); });

    // --- Focus mode (persisted) ---
    const toggleFocusBtn = $('toggleFocus');
    const focusBack = $('focusBack');
    const focusStop = $('focusStop');
    const focusAppendNow = $('focusAppendNow');
    const focusTitle = $('focusTitle');
    const focusNote = $('focusNote');
    const focusMeta = $('focusMeta');

    function setFocus(on){
      localStorage.setItem('edge_focus', on ? '1':'0');
      app.classList.toggle('focus', on);
      if(on) updateFocusScreen();
    }

    toggleFocusBtn.onclick = ()=> setFocus(true);
    focusBack.onclick = ()=> setFocus(false);

    // --- Data ---
    let tasks = JSON.parse(localStorage.getItem('edge_tasks')||'[]');
    let selectedId = localStorage.getItem('edge_selected') || null;

    const listEl = $('list');
    const nowTitle = $('nowTitle');
    const nowMeta = $('nowMeta');
    const timeNote = $('timeNote');
    const quickAdd = $('quickAdd');
    const addBtn = $('addBtn');
    const appendNowBtn = $('appendNow');
    const saveNoteBtn = $('saveNote');
    const summaryCount = $('summaryCount');
    const doneCount = $('doneCount');

    function save(){
      localStorage.setItem('edge_tasks', JSON.stringify(tasks));
      localStorage.setItem('edge_selected', selectedId || '');
      render();
    }

    function getRunningTask(){ return tasks.find(t=>t.running); }

    function setSelected(taskId){
      selectedId = taskId;
      const t = tasks.find(x=>x.id===selectedId);
      timeNote.value = t ? (t.note || '') : '';
      save();
    }

    function deleteTask(taskId){
      const t = tasks.find(x=>x.id===taskId);
      if(!t) return;
      const ok = confirm('このタスクを削除しますか？\\n\\n' + t.title);
      if(!ok) return;
      if(t.running){
        const last = t.logs[t.logs.length-1];
        if(last && !last.end) last.end = Date.now();
      }
      tasks = tasks.filter(x=>x.id!==taskId);
      if(selectedId === taskId) selectedId = null;
      save();
    }

    function visibleTasks(){
      let arr = tasks.slice();
      if(todayOnly.checked) arr = arr.filter(t=>isToday(t.created));
      if(hideDone.checked) arr = arr.filter(t=>!t.done);

      const dir = (orderSelect.value === 'top') ? -1 : 1; // top = newest first
      arr.sort((a,b)=> (a.created - b.created) * dir);
      return arr;
    }

    function stopAllExcept(taskId){
      tasks.forEach(t=>{
        if(t.running && t.id !== taskId){
          t.running = false;
          const last = t.logs[t.logs.length-1];
          if(last && !last.end) last.end = Date.now();
        }
      });
    }

    function toggleRun(taskId){
      const t = tasks.find(x=>x.id===taskId);
      if(!t) return;

      if(!t.running){
        stopAllExcept(taskId);
        t.running = true;
        t.logs.push({start:Date.now(), note: t.note || ''});
        selectedId = t.id;
        timeNote.value = t.note || '';
      } else {
        t.running = false;
        const last = t.logs[t.logs.length-1];
        if(last && !last.end) last.end = Date.now();
      }
      save();
    }

    function toggleDone(taskId){
      const t = tasks.find(x=>x.id===taskId);
      if(!t) return;
      t.done = !t.done;
      if(t.done && t.running){
        t.running = false;
        const last = t.logs[t.logs.length-1];
        if(last && !last.end) last.end = Date.now();
      }
      save();
    }

    function updateNowBar(){
      const r = getRunningTask();
      if(r){
        nowTitle.textContent = `いま: ${r.title}`;
        nowMeta.textContent = r.note ? `メモ: ${r.note}` : 'メモなし（下のメモ欄で追記できます）';
      } else if(selectedId){
        const t = tasks.find(x=>x.id===selectedId);
        nowTitle.textContent = t ? `選択中: ${t.title}` : 'いま: （未選択）';
        nowMeta.textContent = '開始すると“いま”に表示されます。';
      } else {
        nowTitle.textContent = 'いま: （未選択）';
        nowMeta.textContent = '下でタスクを追加 → 一覧から開始。';
      }
    }

    function updateFocusScreen(){
      const r = getRunningTask();
      if(r){
        focusMeta.textContent = '集中モード（開始中タスクのみ表示）';
        focusTitle.textContent = r.title;
        focusNote.textContent = r.note ? r.note : 'メモなし（下の「＋いま」「開始/終了」「/」「次：」で追記できます）';
        focusStop.disabled = false;
        focusAppendNow.disabled = false;
      } else {
        focusMeta.textContent = '集中モード';
        focusTitle.textContent = '（開始中タスクなし）';
        focusNote.textContent = '開始中タスクがありません。通常表示に戻って「開始」してください。';
        focusStop.disabled = true;
        focusAppendNow.disabled = true;
      }
    }

    function render(){
      listEl.innerHTML='';
      const shown = visibleTasks();

      shown.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'list-item' + (t.running ? ' running':'' ) + (t.id===selectedId ? ' selected':'' );

        const cb = document.createElement('div');
        cb.className='checkbox'+(t.done? ' done':'');
        cb.innerHTML = t.done ? '✓' : '';
        cb.onclick = (ev)=>{ ev.stopPropagation(); toggleDone(t.id); };

        const body = document.createElement('div');
        body.className='item-body';

        const title = document.createElement('div');
        title.className='item-title';
        title.textContent = t.title;

        const sub = document.createElement('div');
        sub.className='item-sub';
        sub.textContent = t.note || '';

        body.appendChild(title);
        body.appendChild(sub);

        const actions = document.createElement('div');
        actions.className='item-actions';

        const runBtn = document.createElement('button');
        runBtn.className = 'primary';
        runBtn.textContent = t.running ? '停止' : '開始';
        runBtn.onclick = (ev)=>{ ev.stopPropagation(); toggleRun(t.id); };

        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.title = '削除';
        delBtn.textContent = '削除';
        delBtn.onclick = (ev)=>{ ev.stopPropagation(); deleteTask(t.id); };

        actions.appendChild(runBtn);
        actions.appendChild(delBtn);

        el.appendChild(cb);
        el.appendChild(body);
        el.appendChild(actions);

        el.onclick = ()=> setSelected(t.id);

        listEl.appendChild(el);
      });

      summaryCount.textContent = tasks.length;
      doneCount.textContent = tasks.filter(t=>t.done && isToday(t.created)).length;

      updateNowBar();
      evaluateAutoCompact();

      if(localStorage.getItem('edge_focus') === '1'){
        app.classList.add('focus');
        updateFocusScreen();
      } else {
        app.classList.remove('focus');
      }
    }

    // --- Add ---
    addBtn.onclick = ()=>{
      const title = quickAdd.value.trim();
      if(!title) return;
      const t = { id:'id'+Date.now(), title, note:'', done:false, created:Date.now(), running:false, logs:[] };
      tasks.push(t);
      quickAdd.value='';
      setSelected(t.id);
    };

    // --- Memo helpers ---
    function appendTextToNote(txt){
      const cur = timeNote.value || '';
      timeNote.value = cur ? (cur + txt) : txt;
    }

    function appendNowToNote(){
      const stamp = nowHM();
      const cur = timeNote.value || '';
      const next = cur ? (cur.trim().endsWith('-') || cur.trim().endsWith('–') ? `${cur}${stamp}` : `${cur} ${stamp}`) : stamp;
      timeNote.value = next;
    }

    function appendStart(){
      const stamp = nowHM();
      const cur = timeNote.value || '';
      // If empty or ends with separator, add "HH:MM-". Otherwise add " HH:MM-".
      const prefix = cur && !cur.endsWith(' ') ? ' ' : '';
      timeNote.value = cur ? (cur + prefix + stamp + '-') : (stamp + '-');
    }

    function appendEnd(){
      const stamp = nowHM();
      const cur = timeNote.value || '';
      const prefix = cur && !cur.endsWith(' ') ? ' ' : '';
      timeNote.value = cur ? (cur + prefix + stamp) : stamp;
    }

    $('chipStart').onclick = ()=> appendStart();
    $('chipEnd').onclick = ()=> appendEnd();
    $('chipSlash').onclick = ()=> appendTextToNote(' / ');
    $('chipNext').onclick = ()=> appendTextToNote(' 次: ');

    appendNowBtn.onclick = ()=> appendNowToNote();

    saveNoteBtn.onclick = ()=>{
      if(!selectedId) return alert('先にタスクを選んでください');
      const t = tasks.find(x=>x.id===selectedId);
      if(!t) return;
      t.note = timeNote.value;
      const last = t.logs[t.logs.length-1];
      if(t.running && last && !last.end){ last.note = t.note; }
      save();
    };

    // Focus buttons
    focusStop.onclick = ()=>{
      const r = getRunningTask();
      if(r) toggleRun(r.id);
      updateFocusScreen();
    };

    focusAppendNow.onclick = ()=>{
      const r = getRunningTask();
      if(!r) return;
      selectedId = r.id;
      timeNote.value = r.note || '';
      appendNowToNote();
      r.note = timeNote.value;
      const last = r.logs[r.logs.length-1];
      if(r.running && last && !last.end){ last.note = r.note; }
      save();
      updateFocusScreen();
    };

    // --- Clear ---
    $('clearBtn').onclick = ()=>{
      if(confirm('全てのタスクを削除しますか？')){
        tasks=[];
        selectedId=null;
        localStorage.removeItem('edge_selected');
        save();
      }
    };

    // --- Summary ---
    const dialog = $('summaryDialog');
    const summaryText = $('summaryText');
    const summaryMeta = $('summaryMeta');

    function buildSummaryText(){
      const today = localYMD(new Date());
      const todays = tasks.filter(t=>isToday(t.created));
      const done = todays.filter(t=>t.done);
      const doing = todays.filter(t=>!t.done);

      const lines = [];
      lines.push(`【${today} 作業サマリー】`);
      lines.push(`合計: ${todays.length} / 完了: ${done.length} / 未完了: ${doing.length}`);
      lines.push('');

      const running = getRunningTask();
      if(running){
        lines.push('■ いま（進行中）');
        lines.push(`- ${running.title}${running.note? `（${running.note}）`:''}`);
        lines.push('');
      }

      if(doing.length){
        lines.push('■ 未完了');
        doing.forEach((t,i)=> lines.push(`${i+1}. ${t.title}${t.note? `（${t.note}）`:''}`));
        lines.push('');
      }

      if(done.length){
        lines.push('■ 完了');
        done.forEach((t,i)=> lines.push(`${i+1}. ${t.title}${t.note? `（${t.note}）`:''}`));
        lines.push('');
      }

      lines.push('■ メモ');
      lines.push('・');
      return lines.join('\\n');
    }

    $('openSummary').onclick = ()=>{
      const today = localYMD(new Date());
      const todays = tasks.filter(t=>isToday(t.created));
      const done = todays.filter(t=>t.done).length;
      summaryMeta.textContent = `${today} / 合計 ${todays.length} 件 / 完了 ${done} 件`;
      summaryText.value = buildSummaryText();
      dialog.showModal();
    };

    $('closeSummary').onclick = ()=> dialog.close();

    $('copySummary').onclick = async ()=>{
      try{ await navigator.clipboard.writeText(summaryText.value); alert('サマリーをコピーしました'); }
      catch(e){ summaryText.select(); document.execCommand('copy'); alert('サマリーをコピーしました'); }
    };

    $('downloadSummary').onclick = ()=>{
      const txt = summaryText.value;
      const blob = new Blob([txt], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'edge_summary_'+(new Date().toISOString().slice(0,10))+'.txt';
      a.click();
      URL.revokeObjectURL(url);
    };

    // --- Keyboard shortcuts ---
    document.addEventListener('keydown', e=>{
      if(e.key==='n'){ quickAdd.focus(); e.preventDefault(); }
      if(e.key==='c'){
        const r = getRunningTask();
        if(r) toggleRun(r.id);
        else if(selectedId) toggleRun(selectedId);
        else alert('先にタスクを選んでください');
        e.preventDefault();
      }
      if(e.key==='d'){
        if(selectedId) toggleDone(selectedId);
        else alert('先にタスクを選んでください');
        e.preventDefault();
      }
      if(e.key==='f'){
        setFocus(true);
        e.preventDefault();
      }
      if(e.key==='Escape'){
        if(dialog.open) dialog.close();
        if(settingsDialog.open) settingsDialog.close();
        if(app.classList.contains('focus')) setFocus(false);
      }
    });

    // init
    evaluateAutoCompact();
    render();

    // Restore focus if it was on
    if(localStorage.getItem('edge_focus') === '1'){
      setFocus(true);
    }
  </script>
</body>
</html>
